<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveillance Raspberry Pi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            padding-top: 20px;
            background-color: #f5f5f5;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #6c757d;
            color: white;
            font-weight: bold;
            border-radius: 10px 10px 0 0;
        }
        .metric {
            text-align: center;
            padding: 15px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        .metric-label {
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-microchip text-danger"></i> Tableau de bord Raspberry Pi (192.168.0.2)</h1>
                <div>
                    <span id="connection-status" class="badge bg-warning">En attente...</span>
                    <span id="update-time" class="text-muted ms-2">Dernière mise à jour: --:--:--</span>
                </div>
            </div>
        </header>

        <div class="text-end mb-2" style="font-size: 0.8rem; color: #6c757d;">
            <span class="me-2">Dernière actualisation: <span id="debug-timestamp"></span></span>
            <span class="badge bg-secondary">v1.0</span>
        </div>

        <div class="row">
            <!-- Carte CPU -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-microchip me-2"></i> CPU
                    </div>
                    <div class="card-body">
                        <div class="metric">
                            <div class="metric-value" id="cpu-load">0%</div>
                            <div class="metric-label">Utilisation CPU</div>
                        </div>
                        <div class="progress mb-3">
                            <div id="cpu-progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="small text-muted" id="cpu-model">Modèle: --</div>
                            <div class="small text-muted" id="cpu-cores">Cœurs: --</div>
                        </div>
                        <div class="small text-muted" id="cpu-temp">Température: -- °C</div>
                    </div>
                </div>
            </div>

            <!-- Carte mémoire -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-memory me-2"></i> Mémoire
                    </div>
                    <div class="card-body">
                        <div class="metric">
                            <div class="metric-value" id="memory-used">0 / 0 GB</div>
                            <div class="metric-label">Mémoire utilisée</div>
                        </div>
                        <div class="progress mb-3">
                            <div id="memory-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="small text-muted" id="memory-free">Libre: -- GB</div>
                            <div class="small text-muted" id="memory-percentage">Utilisée: --%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carte stockage -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-hdd me-2"></i> Stockage
                    </div>
                    <div class="card-body">
                        <div id="disk-info">
                            Chargement des données de stockage...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Graphique CPU en temps réel -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line me-2"></i> Utilisation CPU en temps réel
                    </div>
                    <div class="card-body">
                        <div style="height: 250px; width: 100%;">
                            <canvas id="cpuChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graphique réseau en temps réel -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-network-wired me-2"></i> Trafic réseau en temps réel
                    </div>
                    <div class="card-body">
                        <div style="height: 250px; width: 100%;">
                            <canvas id="networkChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Conteneurs Docker -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fab fa-docker me-2"></i> Conteneurs Docker
                        <button class="btn btn-sm btn-outline-light float-end" id="refresh-docker">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Image</th>
                                        <th>Statut</th>
                                        <th>CPU</th>
                                        <th>Mémoire</th>
                                        <th>Réseau</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="docker-containers">
                                    <tr>
                                        <td colspan="7" class="text-center">Chargement des conteneurs Docker...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EarnApp Status -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-money-bill-wave me-2"></i> EarnApp
                        <button class="btn btn-sm btn-outline-light float-end" id="refresh-earnapp">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="earnapp-status">
                            Vérification du statut EarnApp...
                        </div>
                        <div id="earnapp-network" class="mt-3">
                            <!-- Les statistiques réseau seront insérées ici -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- PiVPN Status -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-shield-alt me-2"></i> PiVPN
                        <button class="btn btn-sm btn-outline-light float-end" id="refresh-pivpn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="pivpn-status">
                            Vérification du statut PiVPN...
                        </div>
                        <div class="mt-3">
                            <h6 class="border-bottom pb-2">Informations serveur</h6>
                            <div class="small">
                                <div id="pivpn-server-info">Chargement...</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6 class="d-flex justify-content-between border-bottom pb-2">
                                Clients connectés
                                <span id="pivpn-clients-count" class="badge bg-primary">0/0</span>
                            </h6>
                            <div id="pivpn-clients" class="small">
                                <div class="text-center text-muted py-3">Aucun client connecté</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://192.168.0.2:3000/api';
        const WS_URL = 'ws://192.168.0.2:3000';
        const DEBUG = true; // Activer le mode de débogage
        
        // Mise à jour du timestamp de débogage
        document.getElementById('debug-timestamp').textContent = new Date().toLocaleString();
        
        // Variables pour les statistiques réseau
        const containerNetworkStats = {};
        const earnappNetworkStats = { timestamp: 0, rx_bytes: 0, tx_bytes: 0 };
        
        // Fonctions utilitaires
        function logDebug(message, data) {
            if (DEBUG) {
                console.log(message, data);
            }
        }
        
        function logError(message, error) {
            console.error(message, error);
            document.getElementById('connection-status').className = 'badge bg-danger';
            document.getElementById('connection-status').textContent = 'Erreur';
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('update-time').textContent = 
                `Dernière mise à jour: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        function formatBytesPerSecond(bytesPerSecond, decimals = 2) {
            return formatBytes(bytesPerSecond, decimals) + '/s';
        }
        
        function calculateRate(currentBytes, previousBytes, timeDiffMs) {
            if (!previousBytes || !timeDiffMs || timeDiffMs === 0) {
                return 0;
            }
            
            const byteDiff = currentBytes - previousBytes;
            // Convertir de ms à secondes
            const timeDiffSec = timeDiffMs / 1000;
            
            return byteDiff / timeDiffSec;
        }
        
        // Fonction pour charger le statut de PiVPN
        async function loadPiVPNStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/pivpn`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                logDebug('Données PiVPN reçues:', data);
                
                const statusContainer = document.getElementById('pivpn-status');
                const serverInfoContainer = document.getElementById('pivpn-server-info');
                const clientsContainer = document.getElementById('pivpn-clients');
                const clientsCountBadge = document.getElementById('pivpn-clients-count');
                
                if (!statusContainer || !serverInfoContainer || !clientsContainer || !clientsCountBadge) {
                    console.error('Éléments DOM PiVPN non trouvés');
                    return;
                }
                
                // Mise à jour du statut
                const statusClass = data.status === 'running' ? 'success' : 'warning';
                statusContainer.innerHTML = `
                    <div class="alert alert-${statusClass}">
                        PiVPN est ${data.status === 'running' ? 'en cours d\'exécution' : 'dans un état inconnu'}
                    </div>
                `;
                
                // Mise à jour des informations serveur
                let serverInfo = '';
                if (data.serverAddress) {
                    serverInfo += `<div><strong>Serveur:</strong> ${data.serverAddress}</div>`;
                }
                if (data.serverPort) {
                    serverInfo += `<div><strong>Port:</strong> ${data.serverPort}</div>`;
                }
                if (data.dnsServer) {
                    serverInfo += `<div><strong>Serveur DNS:</strong> ${data.dnsServer}</div>`;
                }
                
                serverInfoContainer.innerHTML = serverInfo || 'Aucune information serveur disponible';
                
                // Mise à jour du nombre de clients
                if (data.clientsCount) {
                    clientsCountBadge.textContent = `${data.clientsCount.connected}/${data.clientsCount.total}`;
                } else {
                    clientsCountBadge.textContent = '0/0';
                }
                
                // Mise à jour de la liste des clients
                if (data.clients && data.clients.length > 0) {
                    let clientsHtml = '<div class="table-responsive"><table class="table table-sm table-hover">';
                    clientsHtml += '<thead><tr><th>Nom</th><th>Statut</th><th>IP</th></tr></thead><tbody>';
                    
                    data.clients.forEach(client => {
                        const statusIcon = client.connected 
                            ? '<i class="fas fa-circle text-success"></i>' 
                            : '<i class="fas fa-circle text-secondary"></i>';
                        
                        const statusText = client.connected 
                            ? 'Connecté' 
                            : `Déconnecté (${client.lastSeen})`;
                        
                        const ipDisplay = client.connected 
                            ? `${client.virtualIP}<br><small class="text-muted">${client.remoteIP}</small>` 
                            : '-';
                        
                        clientsHtml += `
                            <tr>
                                <td>${client.name}</td>
                                <td>
                                    ${statusIcon} 
                                    <span class="ms-1">${statusText}</span>
                                </td>
                                <td>${ipDisplay}</td>
                            </tr>
                        `;
                    });
                    
                    clientsHtml += '</tbody></table></div>';
                    clientsContainer.innerHTML = clientsHtml;
                } else {
                    clientsContainer.innerHTML = '<div class="text-center text-muted py-3">Aucun client configuré</div>';
                }
            } catch (error) {
                logError('Erreur de chargement du statut PiVPN:', error);
                const statusContainer = document.getElementById('pivpn-status');
                if (statusContainer) {
                    statusContainer.innerHTML = '<div class="alert alert-danger">Erreur de chargement du statut PiVPN</div>';
                }
            }
        }

        // Ajoutez ces lignes dans la fonction document.addEventListener('DOMContentLoaded', function() {...})
        // après loadEarnAppStatus():

        // Chargement initial des données PiVPN
        loadPiVPNStatus();

        // Gestionnaire d'événement pour le bouton de rafraîchissement PiVPN
        document.getElementById('refresh-pivpn').addEventListener('click', loadPiVPNStatus);

        // Rafraîchissement périodique du statut PiVPN
        setInterval(loadPiVPNStatus, 60000);  // Toutes les 60 secondes

        // Initialisation des graphiques (seulement une fois que le DOM est chargé)
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            
            // Chargement initial des données
            loadSystemInfo();
            loadDockerContainers();
            loadEarnAppStatus();
            
            // Initialisation des WebSockets
            initWebSocket();
            
            // Gestionnaires d'événements pour les boutons de rafraîchissement
            document.getElementById('refresh-docker').addEventListener('click', loadDockerContainers);
            document.getElementById('refresh-earnapp').addEventListener('click', loadEarnAppStatus);
            
            // Rafraîchissement périodique des données qui ne sont pas en temps réel
            setInterval(loadDockerContainers, 30000);  // Toutes les 30 secondes
            setInterval(loadEarnAppStatus, 60000);     // Toutes les 60 secondes
        });
        
        // Initialisation sécurisée des graphiques
        function initCharts() {
            logDebug('Initialisation des graphiques');
            
            try {
                // Graphique CPU
                const cpuChartElement = document.getElementById('cpuChart');
                if (cpuChartElement) {
                    window.cpuChart = new Chart(cpuChartElement.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array(30).fill(''),
                            datasets: [{
                                label: 'Utilisation CPU (%)',
                                data: Array(30).fill(0),
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Utilisation (%)'
                                    }
                                },
                                x: {
                                    display: false
                                }
                            },
                            animation: {
                                duration: 0
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                    logDebug('Graphique CPU initialisé');
                } else {
                    logError('Élément cpuChart introuvable');
                }
                
                // Graphique réseau
                const networkChartElement = document.getElementById('networkChart');
                if (networkChartElement) {
                    window.networkChart = new Chart(networkChartElement.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array(30).fill(''),
                            datasets: [
                                {
                                    label: 'Téléchargement (KiB/s)',
                                    data: Array(30).fill(0),
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Envoi (KiB/s)',
                                    data: Array(30).fill(0),
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'KiB/s'
                                    }
                                },
                                x: {
                                    display: false
                                }
                            },
                            animation: {
                                duration: 0
                            }
                        }
                    });
                    logDebug('Graphique réseau initialisé');
                } else {
                    logError('Élément networkChart introuvable');
                }
            } catch (error) {
                logError('Erreur lors de l initialisation des graphiques:', error);
            }
        }
        
        // Fonction pour mettre à jour un graphique
        function updateChart(chart, newValue, datasetIndex = 0) {
            try {
                if (chart && chart.data && chart.data.datasets && chart.data.datasets[datasetIndex]) {
                    chart.data.datasets[datasetIndex].data.push(newValue);
                    chart.data.datasets[datasetIndex].data.shift();
                    chart.update();
                }
            } catch (error) {
                logError('Erreur de mise à jour du graphique:', error);
            }
        }

        // Chargement des informations système
        async function loadSystemInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/system`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                logDebug('Données système reçues:', data);
                
                // Mise à jour CPU
                if (data.cpu) {
                    document.getElementById('cpu-load').textContent = `${data.cpu.load}%`;
                    document.getElementById('cpu-progress').style.width = `${data.cpu.load}%`;
                    document.getElementById('cpu-progress').setAttribute('aria-valuenow', data.cpu.load);
                    
                    if (data.cpu.model) {
                        document.getElementById('cpu-model').textContent = `Modèle: ${data.cpu.model}`;
                    }
                    
                    if (data.cpu.cores) {
                        document.getElementById('cpu-cores').textContent = `Cœurs: ${data.cpu.cores}`;
                    }
                }
                
                // Mise à jour température
                if (data.temperature && data.temperature.main) {
                    document.getElementById('cpu-temp').textContent = `Température: ${data.temperature.main}°C`;
                }
                
                // Mise à jour mémoire
                if (data.memory) {
                    document.getElementById('memory-used').textContent = `${data.memory.used} / ${data.memory.total}`;
                    document.getElementById('memory-free').textContent = `Libre: ${data.memory.free}`;
                    document.getElementById('memory-percentage').textContent = `Utilisée: ${data.memory.usedPercentage}%`;
                    document.getElementById('memory-progress').style.width = `${data.memory.usedPercentage}%`;
                    document.getElementById('memory-progress').setAttribute('aria-valuenow', data.memory.usedPercentage);
                }
                
                // Mise à jour disque
                if (data.disk && Array.isArray(data.disk)) {
                    const diskContainer = document.getElementById('disk-info');
                    diskContainer.innerHTML = '';
                    
                    data.disk.forEach(disk => {
                        const diskElement = document.createElement('div');
                        diskElement.className = 'mb-3';
                        diskElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>${disk.fs}</span>
                                <span>${disk.used} / ${disk.size}</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-info" role="progressbar" 
                                    style="width: ${disk.usedPercentage}%" 
                                    aria-valuenow="${disk.usedPercentage}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                    ${disk.usedPercentage}%
                                </div>
                            </div>
                        `;
                        diskContainer.appendChild(diskElement);
                    });
                }
                
                document.getElementById('connection-status').className = 'badge bg-success';
                document.getElementById('connection-status').textContent = 'Connecté';
                updateTime();
            } catch (error) {
                logError('Erreur de chargement des informations système:', error);
            }
        }

        // Chargement des conteneurs Docker
        async function loadDockerContainers() {
            try {
                const response = await fetch(`${API_BASE_URL}/docker`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                logDebug('Données Docker reçues:', data);
                
                const containersList = document.getElementById('docker-containers');
                containersList.innerHTML = '';
                
                if (data.containers && data.containers.length > 0) {
                    data.containers.forEach(container => {
                        const statusClass = container.status.includes('Up') ? 'success' : 'warning';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${container.name}</td>
                            <td><small>${container.image}</small></td>
                            <td><span class="badge bg-${statusClass}">${container.status}</span></td>
                            <td id="cpu-${container.id}">-</td>
                            <td id="mem-${container.id}">-</td>
                            <td id="net-${container.id}">-</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info docker-stats" data-id="${container.id}">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </td>
                        `;
                        containersList.appendChild(row);
                        
                        // Chargement des stats pour ce conteneur
                        loadContainerStats(container.id);
                    });
                    
                    // Ajouter les événements aux boutons
                    document.querySelectorAll('.docker-stats').forEach(button => {
                        button.addEventListener('click', function() {
                            const containerId = this.getAttribute('data-id');
                            loadContainerStats(containerId);
                        });
                    });
                } else {
                    containersList.innerHTML = '<tr><td colspan="7" class="text-center">Aucun conteneur Docker en cours d exécution</td></tr>';
                }
            } catch (error) {
                logError('Erreur de chargement des conteneurs Docker:', error);
                document.getElementById('docker-containers').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Erreur de chargement des conteneurs</td></tr>';
            }
        }

        // Chargement des statistiques Docker
        async function loadContainerStats(containerId) {
            try {
                // Charger les stats CPU/mémoire
                const response = await fetch(`${API_BASE_URL}/docker/${containerId}/stats`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                logDebug(`Stats pour conteneur ${containerId}:`, data);
                
                const cpuElement = document.getElementById(`cpu-${containerId}`);
                if (cpuElement) {
                    cpuElement.textContent = data.cpuPerc || '-';
                }
                
                const memElement = document.getElementById(`mem-${containerId}`);
                if (memElement) {
                    memElement.textContent = data.memPerc ? `${data.memPerc} (${data.memUsage})` : '-';
                }
                
                // Charger les stats réseau
                try {
                    const netResponse = await fetch(`${API_BASE_URL}/docker/${containerId}/network`);
                    if (netResponse.ok) {
                        const netData = await netResponse.json();
                        logDebug(`Stats réseau pour conteneur ${containerId}:`, netData);
                        
                        const prevStats = containerNetworkStats[containerId];
                        const currentTime = Date.now();
                        
                        // Calculer les taux s'il y a des données précédentes
                        let rxRate = 0;
                        let txRate = 0;
                        
                        if (prevStats && prevStats.timestamp) {
                            const timeDiff = currentTime - prevStats.timestamp;
                            rxRate = calculateRate(netData.rx_bytes, prevStats.rx_bytes, timeDiff);
                            txRate = calculateRate(netData.tx_bytes, prevStats.tx_bytes, timeDiff);
                        }
                        
                        // Mettre à jour les statistiques stockées
                        containerNetworkStats[containerId] = {
                            rx_bytes: netData.rx_bytes,
                            tx_bytes: netData.tx_bytes,
                            timestamp: currentTime
                        };
                        
                        // Mettre à jour l'interface utilisateur
                        const netElement = document.getElementById(`net-${containerId}`);
                        if (netElement) {
                            netElement.innerHTML = `
                                <div>
                                    <span class="badge bg-success">↓ ${formatBytesPerSecond(rxRate)}</span>
                                    <span class="badge bg-danger">↑ ${formatBytesPerSecond(txRate)}</span>
                                </div>
                            `;
                        }
                    }
                } catch (netError) {
                    console.warn(`Impossible de charger les stats réseau pour ${containerId}:`, netError);
                    const netElement = document.getElementById(`net-${containerId}`);
                    if (netElement) {
                        netElement.textContent = '- / -';
                    }
                }
            } catch (error) {
                logError(`Erreur de chargement des stats pour ${containerId}:`, error);
            }
        }

        // Chargement des statistiques EarnApp
        async function loadEarnAppStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/earnapp`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                logDebug('Données EarnApp reçues:', data);
                
                const statusContainer = document.getElementById('earnapp-status');
                
                if (data.status === 'running') {
                    let logHtml = '<div class="alert alert-success">EarnApp est en cours d\'exécution</div>';
                    
                    if (data.logs && data.logs.length > 0) {
                        logHtml += '<div class="mt-3"><strong>Derniers logs:</strong></div>';
                        logHtml += '<div class="small" style="max-height: 150px; overflow-y: auto;">';
                        data.logs.forEach(log => {
                            logHtml += `<div class="text-muted">${log}</div>`;
                        });
                        logHtml += '</div>';
                    }
                    
                    statusContainer.innerHTML = logHtml;
                    
                    // Charger et afficher les statistiques réseau
                    loadEarnAppNetworkStats();
                } else {
                    statusContainer.innerHTML = '<div class="alert alert-warning">EarnApp n\'est pas en cours d\'exécution</div>';
                    // Effacer les statistiques réseau
                    const networkContainer = document.getElementById('earnapp-network');
                    if (networkContainer) {
                        networkContainer.innerHTML = '';
                    }
                }
            } catch (error) {
                logError('Erreur de chargement du statut EarnApp:', error);
                document.getElementById('earnapp-status').innerHTML = 
                    '<div class="alert alert-danger">Erreur de chargement du statut EarnApp</div>';
            }
        }

        // Chargement des statistiques réseau d'EarnApp
        async function loadEarnAppNetworkStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/earnapp/network`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                logDebug('Données réseau EarnApp reçues:', data);
                
                const statusContainer = document.getElementById('earnapp-network');
                if (!statusContainer) {
                    return;
                }
                
                // Si nous avons déjà reçu des données auparavant, calculer le taux
                let rxRate = 0;
                let txRate = 0;
                
                if (data.type === 'docker_container' || data.type === 'system_process') {
                    // Ces types de données fournissent déjà des taux
                    if (data.rx_bytes_per_sec !== undefined) {
                        rxRate = data.rx_bytes_per_sec;
                    }
                    if (data.tx_bytes_per_sec !== undefined) {
                        txRate = data.tx_bytes_per_sec;
                    }
                } else if (data.type === 'estimate') {
                    // Ces types de données fournissent déjà des estimations de taux
                    rxRate = data.estimated_rx_bytes_per_sec;
                    txRate = data.estimated_tx_bytes_per_sec;
                } else {
                    // Pour les autres types, calculer le taux à partir des totaux
                    const prevStats = earnappNetworkStats;
                    const currentTime = Date.now();
                    
                    if (prevStats && prevStats.timestamp && data.rx_bytes !== undefined) {
                        const timeDiff = currentTime - prevStats.timestamp;
                        rxRate = calculateRate(data.rx_bytes, prevStats.rx_bytes, timeDiff);
                        txRate = calculateRate(data.tx_bytes, prevStats.tx_bytes, timeDiff);
                    }
                    
                    // Mettre à jour les statistiques stockées
                    if (data.rx_bytes !== undefined) {
                        earnappNetworkStats.rx_bytes = data.rx_bytes;
                        earnappNetworkStats.tx_bytes = data.tx_bytes;
                        earnappNetworkStats.timestamp = currentTime;
                    }
                }
                
                // Mettre à jour l'interface utilisateur
                statusContainer.innerHTML = `
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-network-wired me-2"></i> Trafic réseau
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <i class="fas fa-arrow-down text-success"></i> Téléchargement:
                                </div>
                                <div>
                                    <strong>${formatBytesPerSecond(rxRate)}</strong>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <i class="fas fa-arrow-up text-danger"></i> Envoi:
                                </div>
                                <div>
                                    <strong>${formatBytesPerSecond(txRate)}</strong>
                                </div>
                            </div>
                            <div class="text-muted small mt-2">
                                <em>Type de mesure: ${data.type || 'standard'}</em>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                logError('Erreur de chargement des stats réseau EarnApp:', error);
                const statusContainer = document.getElementById('earnapp-network');
                if (statusContainer) {
                    statusContainer.innerHTML = `
                        <div class="alert alert-danger">
                            Impossible de charger les statistiques réseau
                        </div>
                    `;
                }
            }
        }

        // Initialisation des WebSockets
        function initWebSocket() {
            const ws = new WebSocket(WS_URL);
            
            ws.onopen = function() {
                logDebug('WebSocket connecté');
                document.getElementById('connection-status').className = 'badge bg-success';
                document.getElementById('connection-status').textContent = 'Connecté';
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    logDebug('Données WebSocket reçues:', data);
                    
                    // Mise à jour CPU
                    if (data.cpu && data.cpu.load) {
                        document.getElementById('cpu-load').textContent = `${data.cpu.load}%`;
                        document.getElementById('cpu-progress').style.width = `${data.cpu.load}%`;
                        document.getElementById('cpu-progress').setAttribute('aria-valuenow', data.cpu.load);
                        
                        // Mise à jour graphique CPU
                        if (window.cpuChart) {
                            updateChart(window.cpuChart, parseFloat(data.cpu.load));
                        }
                    }
                    
                    // Mise à jour température
                    if (data.temperature && data.temperature.main) {
                        document.getElementById('cpu-temp').textContent = `Température: ${data.temperature.main}°C`;
                    }
                    
                    // Mise à jour mémoire
                    if (data.memory) {
                        if (data.memory.used && data.memory.total) {
                            document.getElementById('memory-used').textContent = `${data.memory.used} / ${data.memory.total} GB`;
                        }
                        
                        if (data.memory.usedPercentage) {
                            document.getElementById('memory-percentage').textContent = `Utilisée: ${data.memory.usedPercentage}%`;
                            document.getElementById('memory-progress').style.width = `${data.memory.usedPercentage}%`;
                            document.getElementById('memory-progress').setAttribute('aria-valuenow', data.memory.usedPercentage);
                        }
                    }
                    
                    // Mise à jour graphique réseau
                    if (data.network && data.network.length > 0 && window.networkChart) {
                        // Prendre la première interface réseau
                        const netInterface = data.network[0];
                        if (netInterface.rx_sec && netInterface.tx_sec) {
                            updateChart(window.networkChart, parseFloat(netInterface.rx_sec), 0);  // Download
                            updateChart(window.networkChart, parseFloat(netInterface.tx_sec), 1);  // Upload
                        }
                    }
                    
                    updateTime();
                } catch (error) {
                    logError('Erreur de traitement des données WebSocket:', error);
                }
            };
            
            ws.onclose = function() {
                logDebug('WebSocket déconnecté');
                document.getElementById('connection-status').className = 'badge bg-danger';
                document.getElementById('connection-status').textContent = 'Déconnecté';
                
                // Tentative de reconnexion après 5 secondes
                setTimeout(initWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                logError('Erreur WebSocket:', error);
                document.getElementById('connection-status').className = 'badge bg-danger';
                document.getElementById('connection-status').textContent = 'Erreur';
            };
        }
    </script>
</body>
</html>